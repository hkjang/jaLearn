// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========================================
// User & Authentication Models
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String?
  role          String    @default("STUDENT") // STUDENT, TEACHER, PARENT, ADMIN
  gradeLevel    String?   // ELEMENTARY_1-6, MIDDLE_1-3, HIGH_1-3
  image         String?
  emailVerified DateTime?
  referralCode  String?   @unique // For referral system
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile       Profile?
  accounts      Account[]
  sessions      Session[]
  enrollments   Enrollment[]
  progress      Progress[]
  submissions   Submission[]
  notifications Notification[]
  studyPlans    StudyPlan[]
  
  // Parent-Child relations
  children      ParentChild[]  @relation("Parent")
  parents       ParentChild[]  @relation("Child")
  
  // Teacher-managed students
  managedStudents StudentTeacher[] @relation("Teacher")
  teachers        StudentTeacher[] @relation("Student")
  
  // Content created by teacher
  createdCourses  Course[]  @relation("CourseCreator")
  createdLessons  Lesson[]  @relation("LessonCreator")
  
  // Payment & Subscription relations
  subscriptions   Subscription[]
  payments        Payment[]
  invoices        Invoice[]
  userCoupons     UserCoupon[]
  referralsMade   Referral[] @relation("Referrer")
  referredBy      Referral[] @relation("Referred")
  
  // Instructor & Marketplace
  instructorProfile InstructorProfile?
  coursePurchases   CoursePurchase[]
  
  // AI Usage
  aiUsage         AIUsage[]
  userCredits     UserCredits?
  
  // AI Tutor Premium
  tutorSessions   AITutorSession[]
  tutorMemory     TutorMemory?
  examGoals       ExamGoal[]
  examCalendars   ExamCalendar[]
  
  // Parent Dashboard
  parentReports   ParentReport[] @relation("ParentReports")
  childReports    ParentReport[] @relation("ChildReports")
  parentAlerts    ParentAlert[]  @relation("ParentAlerts")
  childAlerts     ParentAlert[]  @relation("ChildAlerts")
  
  // Expert Consultations
  userConsultations   ExpertConsultation[] @relation("UserConsultations")
  expertConsultations ExpertConsultation[] @relation("ExpertConsultations")
  
  // Problem Bank
  createdProblems        Problem[] @relation("ProblemCreator")
  problemReviews         ProblemReview[] @relation("ProblemReviewer")
  problemVersions        ProblemVersion[] @relation("ProblemVersionChanger")
  problemSubmissions     ProblemSubmission[] @relation("ProblemSubmissions")
  curriculumVerifications ProblemCurriculumMapping[] @relation("CurriculumVerifier")
  
  // Gamification & Engagement (Phase 1)
  userStreak        UserStreak?
  dailyChallenges   DailyChallenge[]
  userLevel         UserLevel?
  
  // ClassRoom (Teacher/Student)
  teacherClassRooms ClassRoom[] @relation("TeacherClassRooms")
  classMemberships  ClassMember[] @relation("ClassMemberships")
  examResults       ExamResult[] @relation("ExamResults")
  
  // Challenges & Rankings
  challengerChallenges  Challenge[] @relation("ChallengerChallenges")
  challengedChallenges  Challenge[] @relation("ChallengedChallenges")
  rankings              Ranking[]
  
  // Problem Ratings & Q&A
  problemRatings    ProblemRating[]
  sharedQuestions   SharedQuestion[]
  questionAnswers   QuestionAnswer[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id            String   @id @default(cuid())
  userId        String   @unique
  bio           String?
  school        String?
  birthDate     DateTime?
  phoneNumber   String?
  parentConsent Boolean  @default(false)
  consentDate   DateTime?
  avatarStyle   String   @default("default")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// Relationship Models
// ========================================

model ParentChild {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  createdAt DateTime @default(now())
  
  parent User @relation("Parent", fields: [parentId], references: [id], onDelete: Cascade)
  child  User @relation("Child", fields: [childId], references: [id], onDelete: Cascade)
  
  @@unique([parentId, childId])
}

model StudentTeacher {
  id        String   @id @default(cuid())
  studentId String
  teacherId String
  createdAt DateTime @default(now())
  
  student User @relation("Student", fields: [studentId], references: [id], onDelete: Cascade)
  teacher User @relation("Teacher", fields: [teacherId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, teacherId])
}

// ========================================
// Course & Content Models
// ========================================

model Subject {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  iconName    String   @default("book")
  color       String   @default("#6366f1")
  
  courses             Course[]
  problemUnits        ProblemUnit[]
  problems            Problem[]
  curriculumStandards CurriculumStandard[]
}

model Course {
  id          String      @id @default(cuid())
  title       String
  description String?
  thumbnail   String?
  subjectId   String
  gradeLevel  String      // ELEMENTARY_1-6, MIDDLE_1-3, HIGH_1-3
  isPublished Boolean     @default(false)
  creatorId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  subject     Subject     @relation(fields: [subjectId], references: [id])
  creator     User        @relation("CourseCreator", fields: [creatorId], references: [id])
  lessons     Lesson[]
  enrollments Enrollment[]
  prices      CoursePrice[]
  purchases   CoursePurchase[]
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  description String?
  order       Int         @default(0)
  videoUrl    String?
  videoDuration Int?      // in seconds
  pdfUrl      String?
  courseId    String
  creatorId   String
  isPublished Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  creator     User        @relation("LessonCreator", fields: [creatorId], references: [id])
  questions   Question[]
  progress    Progress[]
}

// ========================================
// Question & Quiz Models
// ========================================

model Question {
  id          String       @id @default(cuid())
  lessonId    String
  type        String       @default("MULTIPLE_CHOICE") // MULTIPLE_CHOICE, SHORT_ANSWER, TRUE_FALSE, ESSAY
  content     String       // Question text (supports markdown)
  options     String?      // JSON array for multiple choice options
  answer      String       // Correct answer
  explanation String?      // Explanation for the answer
  difficulty  String       @default("MEDIUM") // EASY, MEDIUM, HARD
  points      Int          @default(10)
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  lesson      Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions Submission[]
}

model Submission {
  id          String    @id @default(cuid())
  userId      String
  questionId  String
  answer      String
  isCorrect   Boolean
  earnedPoints Int      @default(0)
  timeSpent   Int?      // in seconds
  createdAt   DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  question    Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ========================================
// Learning Progress Models
// ========================================

model Enrollment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  enrolledAt  DateTime @default(now())
  completedAt DateTime?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
}

model Progress {
  id              String   @id @default(cuid())
  userId          String
  lessonId        String
  watchedDuration Int      @default(0) // in seconds
  isCompleted     Boolean  @default(false)
  lastPosition    Int      @default(0) // video position in seconds
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
}

model StudyPlan {
  id          String   @id @default(cuid())
  userId      String
  weekStart   DateTime
  weekEnd     DateTime
  goals       String   // JSON array of weekly goals
  isAIGenerated Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       StudyPlanItem[]
}

model StudyPlanItem {
  id          String     @id @default(cuid())
  planId      String
  title       String
  description String?
  dueDate     DateTime
  isCompleted Boolean    @default(false)
  completedAt DateTime?
  priority    String     @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  plan        StudyPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
}

// ========================================
// Notification Models
// ========================================

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        String           // STUDY_REMINDER, ASSIGNMENT_DUE, PROGRESS_UPDATE, NEW_CONTENT, ACHIEVEMENT, SYSTEM
  title       String
  message     String
  link        String?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// AI & Analytics Models
// ========================================

model LearningAnalytics {
  id              String   @id @default(cuid())
  userId          String
  subjectId       String?
  weeklyStudyTime Int      @default(0) // minutes
  correctRate     Float    @default(0)
  weakAreas       String?  // JSON array
  strengths       String?  // JSON array
  analyzedAt      DateTime @default(now())
}

model AIRecommendation {
  id              String   @id @default(cuid())
  userId          String
  type            String   // "problem" | "content" | "study_plan"
  recommendation  String   // JSON data
  reason          String?
  isApplied       Boolean  @default(false)
  createdAt       DateTime @default(now())
}

// ========================================
// Payment & Subscription Models
// ========================================

model Plan {
  id            String   @id @default(cuid())
  name          String   @unique  // FREE, PREMIUM_BASIC, PREMIUM_PLUS
  displayName   String
  description   String?
  price         Int      // Monthly price in KRW
  yearlyPrice   Int?     // Yearly price (discounted)
  features      String   // JSON array of features
  aiQuestionsPerDay Int  @default(10)
  problemsPerDay    Int  @default(10)
  hasAnalytics      Boolean @default(false)
  hasAITutor        Boolean @default(false)
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id            String   @id @default(cuid())
  userId        String
  planId        String
  status        String   @default("ACTIVE") // ACTIVE, PAUSED, CANCELLED, EXPIRED
  billingCycle  String   @default("MONTHLY") // MONTHLY, YEARLY
  startDate     DateTime @default(now())
  endDate       DateTime?
  nextBillingDate DateTime?
  autoRenew     Boolean  @default(true)
  pausedAt      DateTime?
  cancelledAt   DateTime?
  cancelReason  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan     @relation(fields: [planId], references: [id])
  payments      Payment[]
}

model Payment {
  id            String   @id @default(cuid())
  userId        String
  subscriptionId String?
  orderId       String   @unique
  amount        Int
  originalAmount Int?     // Before discount
  discountAmount Int?     // Discount applied
  couponId      String?
  method        String   // CARD, BANK_TRANSFER, KAKAO_PAY, TOSS_PAY, NAVER_PAY
  status        String   @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED, PARTIAL_REFUND
  pgProvider    String?  // TOSS, IAMPORT, etc.
  pgTransactionId String?
  paidAt        DateTime?
  refundedAt    DateTime?
  refundAmount  Int?
  refundReason  String?
  metadata      String?  // JSON for additional info
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription  Subscription? @relation(fields: [subscriptionId], references: [id])
  coupon        Coupon?  @relation(fields: [couponId], references: [id])
  invoices      Invoice[]
}

model Invoice {
  id            String   @id @default(cuid())
  userId        String
  paymentId     String
  invoiceNumber String   @unique
  type          String   // TAX_INVOICE, CASH_RECEIPT
  amount        Int
  taxAmount     Int      @default(0)
  recipientName String?
  recipientEmail String?
  businessNumber String? // 사업자등록번호
  issuedAt      DateTime @default(now())
  status        String   @default("ISSUED") // ISSUED, CANCELLED
  pdfUrl        String?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment       Payment  @relation(fields: [paymentId], references: [id])
}

// ========================================
// Coupon & Promotion Models
// ========================================

model Coupon {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  description   String?
  discountType  String   // PERCENT, FIXED_AMOUNT
  discountValue Int      // Percentage or amount
  minPurchaseAmount Int? // Minimum purchase amount to apply
  maxDiscountAmount Int? // Maximum discount for percentage type
  maxUses       Int?     // Total max uses (null = unlimited)
  usedCount     Int      @default(0)
  maxUsesPerUser Int     @default(1)
  validFrom     DateTime
  validUntil    DateTime
  planIds       String?  // JSON array of applicable plan IDs (null = all)
  isActive      Boolean  @default(true)
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  payments      Payment[]
  userCoupons   UserCoupon[]
}

model UserCoupon {
  id        String   @id @default(cuid())
  userId    String
  couponId  String
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon    Coupon   @relation(fields: [couponId], references: [id])
  
  @@unique([userId, couponId])
}

model Referral {
  id            String   @id @default(cuid())
  referrerId    String   // User who referred
  referredId    String   // User who was referred
  referralCode  String
  status        String   @default("PENDING") // PENDING, COMPLETED, REWARDED
  rewardAmount  Int      @default(0)
  rewardedAt    DateTime?
  createdAt     DateTime @default(now())
  
  referrer      User     @relation("Referrer", fields: [referrerId], references: [id])
  referred      User     @relation("Referred", fields: [referredId], references: [id])
}

// ========================================
// Instructor & Marketplace Models
// ========================================

model InstructorProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  displayName   String
  bio           String?
  specialties   String?  // JSON array of subject specialties
  qualifications String? // JSON array of qualifications
  profileImage  String?
  bannerImage   String?
  socialLinks   String?  // JSON object
  isVerified    Boolean  @default(false)
  verifiedAt    DateTime?
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  rating        Float    @default(0)
  totalStudents Int      @default(0)
  totalEarnings Int      @default(0)
  commissionRate Float   @default(0.3) // Platform takes 30%
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  settlements   InstructorSettlement[]
}

model InstructorSettlement {
  id            String   @id @default(cuid())
  instructorId  String
  periodStart   DateTime
  periodEnd     DateTime
  grossAmount   Int      // Total sales
  commissionAmount Int   // Platform commission
  netAmount     Int      // Amount to pay instructor
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  paidAt        DateTime?
  bankName      String?
  accountNumber String?
  accountHolder String?
  createdAt     DateTime @default(now())
  
  instructor    InstructorProfile @relation(fields: [instructorId], references: [id])
}

model CoursePrice {
  id            String   @id @default(cuid())
  courseId      String
  priceType     String   // SINGLE, PACKAGE, SUBSCRIPTION_ONLY
  price         Int      // Price in KRW
  originalPrice Int?     // Original price (for showing discount)
  validFrom     DateTime @default(now())
  validUntil    DateTime?
  isActive      Boolean  @default(true)
  
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model CoursePurchase {
  id            String   @id @default(cuid())
  userId        String
  courseId      String
  paymentId     String?
  price         Int
  purchasedAt   DateTime @default(now())
  expiresAt     DateTime?
  status        String   @default("ACTIVE") // ACTIVE, EXPIRED, REFUNDED
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course   @relation(fields: [courseId], references: [id])
}

// ========================================
// AI Usage Tracking Models
// ========================================

model AIUsage {
  id            String   @id @default(cuid())
  userId        String
  type          String   // QUESTION, PROBLEM_GEN, ANALYSIS, TUTOR
  tokensUsed    Int      @default(0)
  creditsUsed   Int      @default(1)
  date          DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, date])
}

model UserCredits {
  id            String   @id @default(cuid())
  userId        String   @unique
  freeCredits   Int      @default(0)
  paidCredits   Int      @default(0)
  lastResetDate DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// AI Tutor Premium Models
// ========================================

model AITutorPlan {
  id            String   @id @default(cuid())
  name          String   @unique  // AI_TUTOR_PRO, AI_TUTOR_ELITE, AI_TUTOR_TIME, EXAM_PASS
  displayName   String
  description   String?
  priceType     String   // MONTHLY, PER_MINUTE, PERIOD
  price         Int      // Monthly price or per-minute rate
  features      String   // JSON array
  minuteRate    Int?     // Rate per minute for TIME plan
  maxSessions   Int?     // Max sessions per month (null = unlimited)
  hasRealTimeIntervention Boolean @default(false)
  hasExamAnalysis Boolean @default(false)
  hasMemory     Boolean  @default(true)
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
}

model AITutorSession {
  id            String   @id @default(cuid())
  userId        String
  planType      String   // PRO, ELITE, TIME
  topic         String?
  subject       String?
  gradeLevel    String?
  startTime     DateTime @default(now())
  endTime       DateTime?
  durationMins  Int      @default(0)
  tokensUsed    Int      @default(0)
  messagesCount Int      @default(0)
  cost          Int      @default(0)
  status        String   @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED
  rating        Int?     // 1-5 satisfaction rating
  feedback      String?
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      TutorMessage[]
  
  @@index([userId, startTime])
}

model TutorMessage {
  id            String   @id @default(cuid())
  sessionId     String
  role          String   // USER, TUTOR, SYSTEM
  content       String
  contentType   String   @default("TEXT") // TEXT, LATEX, IMAGE, CODE
  tokensUsed    Int      @default(0)
  isIntervention Boolean @default(false) // Real-time intervention
  metadata      String?  // JSON for additional data
  createdAt     DateTime @default(now())
  
  session       AITutorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model TutorMemory {
  id            String   @id @default(cuid())
  userId        String   @unique
  shortTerm     String   @default("{}") // JSON - recent context
  longTerm      String   @default("{}") // JSON - learning patterns, weaknesses
  preferences   String?  // JSON - learning preferences
  strengths     String?  // JSON - areas of strength
  weaknesses    String?  // JSON - areas needing improvement
  learningStyle String?  // VISUAL, AUDITORY, READING, KINESTHETIC
  lastTopics    String?  // JSON - recent topics covered
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// Exam Prep Models
// ========================================

model ExamGoal {
  id            String   @id @default(cuid())
  userId        String
  examType      String   // SUNEUNG, MOCK, SCHOOL, CERTIFICATE
  examName      String
  targetDate    DateTime
  targetScore   Int?
  currentScore  Int?
  subjects      String   // JSON array of subjects
  strategies    String?  // JSON - study strategies
  status        String   @default("ACTIVE") // ACTIVE, ACHIEVED, EXPIRED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  predictions   ExamPrediction[]
}

model ExamPrediction {
  id            String   @id @default(cuid())
  goalId        String
  predictedScore Int
  confidence    Float    // 0-1
  basedOn       String   // JSON - factors used
  recommendations String? // JSON - improvement suggestions
  createdAt     DateTime @default(now())
  
  goal          ExamGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
}

model ExamCalendar {
  id            String   @id @default(cuid())
  userId        String
  examType      String
  examName      String
  examDate      DateTime
  registrationDeadline DateTime?
  reminderDays  Int      @default(7)
  notes         String?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// Parent Dashboard Models
// ========================================

model ParentReport {
  id            String   @id @default(cuid())
  parentId      String
  childId       String
  reportType    String   // DAILY, WEEKLY, MONTHLY
  period        String   // e.g., "2024-01-15" or "2024-W03"
  studyTime     Int      // Total minutes
  completedLessons Int
  quizScores    String   // JSON array
  aiInteractions Int
  strengths     String?  // JSON
  improvements  String?  // JSON
  aiComment     String?  // AI-generated summary
  createdAt     DateTime @default(now())
  
  parent        User     @relation("ParentReports", fields: [parentId], references: [id])
  child         User     @relation("ChildReports", fields: [childId], references: [id])
}

model ParentAlert {
  id            String   @id @default(cuid())
  parentId      String
  childId       String
  alertType     String   // GRADE_DROP, INACTIVITY, GOAL_RISK, ACHIEVEMENT
  severity      String   @default("INFO") // INFO, WARNING, CRITICAL
  title         String
  message       String
  isRead        Boolean  @default(false)
  actionUrl     String?
  createdAt     DateTime @default(now())
  
  parent        User     @relation("ParentAlerts", fields: [parentId], references: [id])
  child         User     @relation("ChildAlerts", fields: [childId], references: [id])
}

// ========================================
// Expert Consultation Models
// ========================================

model ExpertConsultation {
  id            String   @id @default(cuid())
  userId        String
  expertId      String?
  type          String   // MONTHLY, EMERGENCY, AI_REVIEW
  scheduledAt   DateTime?
  completedAt   DateTime?
  duration      Int?     // Minutes
  notes         String?
  aiSummary     String?  // AI-generated session summary
  status        String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  rating        Int?
  createdAt     DateTime @default(now())
  
  user          User     @relation("UserConsultations", fields: [userId], references: [id])
  expert        User?    @relation("ExpertConsultations", fields: [expertId], references: [id])
}

// ========================================
// Problem Bank Models (문제 은행)
// ========================================

model Problem {
  id            String   @id @default(cuid())
  
  // 기본 정보
  title         String?           // 문제 제목 (선택)
  content       String            // 문제 본문 (마크다운/LaTeX 지원)
  contentHtml   String?           // HTML 렌더링 버전
  
  // 문제 유형
  type          String            // MULTIPLE_CHOICE, SHORT_ANSWER, ESSAY, TRUE_FALSE
  options       String?           // JSON: 객관식 선택지
  answer        String            // 정답
  explanation   String?           // 해설
  
  // 분류 정보
  gradeLevel    String            // ELEMENTARY_1-6, MIDDLE_1-3, HIGH_1-3
  subjectId     String
  unitId        String?
  difficulty    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  // 메타데이터
  sourceId      String?           // 출처
  sourceType    String?           // PUBLIC, SCHOOL, TEXTBOOK, MOCK_EXAM, CUSTOM
  sourceDetail  String?           // 상세 출처 정보
  year          Int?              // 출제 연도
  
  // 저작권
  copyright     String?           // 저작권 정보
  isPublicDomain Boolean @default(false)
  usageScope    String   @default("LEARNING") // LEARNING, AI_TRAINING
  
  // 상태 관리
  status        String   @default("DRAFT") // DRAFT, PENDING, APPROVED, REJECTED, ARCHIVED
  reviewStage   String   @default("NONE")  // NONE, AUTO, AI, MANUAL, APPROVED
  
  // 고도화: 품질 점수 세분화
  qualityScore  Float?            // 종합 품질 점수 0-100
  accuracyScore Float?            // 정답 정확성 0-100
  clarityScore  Float?            // 문장 명확성 0-100
  difficultyFit Float?            // 난이도 적합성 0-100
  trustScore    Float?            // 출처 신뢰도 (등급 기반)
  
  // 사용 통계
  usageCount    Int      @default(0)
  correctRate   Float?            // 정답률
  avgSolveTime  Float?            // 평균 풀이 시간 (초)
  
  // 생성 정보
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  subject       Subject  @relation(fields: [subjectId], references: [id])
  unit          ProblemUnit? @relation(fields: [unitId], references: [id])
  source        ProblemSource? @relation(fields: [sourceId], references: [id])
  createdBy     User?    @relation("ProblemCreator", fields: [createdById], references: [id])
  
  tags          ProblemTagMapping[]
  reviews       ProblemReview[]
  versions      ProblemVersion[]
  variants      ProblemVariant[]
  submissions   ProblemSubmission[]
  curriculumMappings ProblemCurriculumMapping[]
  
  // Phase 1: Gamification relations
  ratings       ProblemRating[]
  sharedQuestions SharedQuestion[]
  
  @@index([subjectId, gradeLevel])
  @@index([status, reviewStage])
  @@index([sourceType])
  @@index([qualityScore])
}

model ProblemSource {
  id            String   @id @default(cuid())
  name          String   @unique  // 출처 이름
  type          String            // PUBLIC, SCHOOL, TEXTBOOK, MOCK_EXAM
  organization  String?           // 발행 기관
  website       String?           // 관련 웹사이트
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  
  // 고도화: 출처 등급 시스템
  grade         String   @default("D") // A, B, C, D, E
  usageScope    String   @default("LEARNING") // LEARNING, AI_TRAINING, INTERNAL
  trustScore    Float    @default(50) // 신뢰도 점수 0-100
  
  problems      Problem[]
  contracts     SourceContract[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// 출처별 계약/라이선스 관리
model SourceContract {
  id            String   @id @default(cuid())
  sourceId      String
  
  contractType  String   // LICENSE, REVENUE_SHARE, DONATION, PARTNERSHIP
  title         String   // 계약명
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean  @default(true)
  autoBlock     Boolean  @default(true) // 만료 시 자동 차단
  
  // 사용 범위
  allowLearning   Boolean @default(true)  // 학습용 허용
  allowAITraining Boolean @default(false) // AI 학습 허용
  allowCommercial Boolean @default(false) // 상업적 사용 허용
  
  revenueShare  Float?   // 수익 쉐어 비율 (%)
  terms         String?  // JSON: 상세 계약 조건
  documentUrl   String?  // 계약서 파일 URL
  notes         String?  // 관리 메모
  
  source        ProblemSource @relation(fields: [sourceId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([sourceId, isActive])
  @@index([endDate])
}

model ProblemUnit {
  id            String   @id @default(cuid())
  name          String            // 단원명
  code          String?           // 단원 코드
  subjectId     String
  gradeLevel    String
  chapter       Int?              // 장
  section       Int?              // 절
  parentId      String?           // 상위 단원
  order         Int      @default(0)
  
  subject       Subject  @relation(fields: [subjectId], references: [id])
  parent        ProblemUnit? @relation("UnitHierarchy", fields: [parentId], references: [id])
  children      ProblemUnit[] @relation("UnitHierarchy")
  problems      Problem[]
  
  @@unique([subjectId, gradeLevel, code])
}

model ProblemTag {
  id            String   @id @default(cuid())
  name          String   @unique
  category      String?           // CONCEPT, SKILL, TOPIC
  color         String   @default("#6366f1")
  
  problems      ProblemTagMapping[]
}

model ProblemTagMapping {
  id            String   @id @default(cuid())
  problemId     String
  tagId         String
  
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  tag           ProblemTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([problemId, tagId])
}

model ProblemReview {
  id            String   @id @default(cuid())
  problemId     String
  reviewerId    String?
  stage         String            // AUTO, AI, MANUAL
  status        String            // PENDING, APPROVED, REJECTED, NEEDS_REVISION
  comments      String?
  score         Float?            // 0-100
  issues        String?           // JSON: 발견된 문제점
  
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  reviewer      User?    @relation("ProblemReviewer", fields: [reviewerId], references: [id])
  
  createdAt     DateTime @default(now())
}

model ProblemVersion {
  id            String   @id @default(cuid())
  problemId     String
  version       Int
  content       String
  options       String?
  answer        String
  explanation   String?
  changeNote    String?
  changedById   String?
  
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  changedBy     User?    @relation("ProblemVersionChanger", fields: [changedById], references: [id])
  
  createdAt     DateTime @default(now())
}

model ProblemVariant {
  id            String   @id @default(cuid())
  originalId    String
  type          String            // NUMERIC, OPTION_ORDER, DIFFICULTY
  content       String
  options       String?
  answer        String
  difficulty    String?
  generatedBy   String   @default("MANUAL") // MANUAL, AI
  
  original      Problem  @relation(fields: [originalId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
}

model ProblemSubmission {
  id            String   @id @default(cuid())
  problemId     String
  userId        String
  answer        String
  isCorrect     Boolean
  timeSpent     Int?     // seconds
  
  problem       Problem  @relation(fields: [problemId], references: [id])
  user          User     @relation("ProblemSubmissions", fields: [userId], references: [id])
  
  createdAt     DateTime @default(now())
  
  @@index([problemId, userId])
}

model ProblemAuditLog {
  id            String   @id @default(cuid())
  problemId     String
  userId        String?
  action        String            // CREATE, UPDATE, DELETE, VIEW, EXPORT
  details       String?           // JSON
  ipAddress     String?
  
  createdAt     DateTime @default(now())
  
  @@index([problemId])
  @@index([userId])
}

// ========================================
// Curriculum Standard Models (교육과정 매핑)
// ========================================

model CurriculumStandard {
  id            String   @id @default(cuid())
  version       String   // "2015", "2022" (교육과정 버전)
  subjectId     String
  gradeLevel    String   // ELEMENTARY_1-6, MIDDLE_1-3, HIGH_1-3
  
  code          String   // 성취기준 코드 (예: [9영01-01])
  domain        String?  // 영역 (예: 듣기-말하기)
  title         String   // 성취기준 제목
  description   String?  // 상세 설명
  keywords      String?  // JSON: 핵심 키워드 배열
  
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  
  subject       Subject  @relation(fields: [subjectId], references: [id])
  mappings      ProblemCurriculumMapping[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([version, code])
  @@index([subjectId, gradeLevel, version])
}

model ProblemCurriculumMapping {
  id            String   @id @default(cuid())
  problemId     String
  standardId    String
  
  confidence    Float    @default(0) // AI 매핑 신뢰도 0-1
  mappedBy      String   // AUTO, MANUAL
  verifiedById  String?  // 교사 승인자 ID
  verifiedAt    DateTime?
  
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  standard      CurriculumStandard @relation(fields: [standardId], references: [id])
  verifiedBy    User?    @relation("CurriculumVerifier", fields: [verifiedById], references: [id])
  
  createdAt     DateTime @default(now())
  
  @@unique([problemId, standardId])
  @@index([standardId])
}

// ========================================
// Problem Crawler Models (문제 자동 수집)
// ========================================

// 수집 대상 사이트
model CollectionSource {
  id            String   @id @default(cuid())
  name          String   @unique
  type          String   // KICE, EDU_OFFICE, COMMUNITY, API, OTHER
  baseUrl       String
  description   String?
  
  // 크롤링 설정
  crawlPattern  String?  // URL 패턴 (정규식)
  linkSelector  String?  // CSS 선택자
  fileTypes     String   @default("pdf,hwp")
  maxDepth      Int      @default(2)
  
  // robots.txt
  robotsChecked Boolean  @default(false)
  robotsAllowed Boolean  @default(true)
  crawlDelay    Int      @default(1000) // ms
  
  // 메타데이터
  grade         String   @default("D") // A-E 신뢰 등급
  isActive      Boolean  @default(true)
  lastCrawledAt DateTime?
  
  jobs          CrawlJob[]
  items         CrawledItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([type, isActive])
}

// 수집 작업
model CrawlJob {
  id            String   @id @default(cuid())
  sourceId      String
  
  status        String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
  priority      Int      @default(0)
  
  // 실행 정보
  startedAt     DateTime?
  completedAt   DateTime?
  
  // 결과 통계
  pagesVisited  Int      @default(0)
  filesFound    Int      @default(0)
  filesSaved    Int      @default(0)
  problemsExtracted Int  @default(0)
  
  // 오류 정보
  errorCount    Int      @default(0)
  lastError     String?
  
  source        CollectionSource @relation(fields: [sourceId], references: [id])
  items         CrawledItem[]
  logs          CrawlLog[]
  
  createdAt     DateTime @default(now())
  
  @@index([sourceId, status])
  @@index([status, createdAt])
}

// 수집된 항목
model CrawledItem {
  id            String   @id @default(cuid())
  sourceId      String
  jobId         String?
  
  // 원본 정보
  url           String
  fileType      String   // pdf, hwp, html, image
  fileName      String?
  filePath      String?  // 로컬 저장 경로
  fileSize      Int?     // bytes
  
  // OCR/파싱 결과
  rawText       String?  // OCR 추출 텍스트
  parsedData    String?  // JSON: 파싱된 문제 배열
  
  // 메타데이터 (추출된)
  year          Int?
  month         Int?
  examName      String?  // 수능, 모의고사, 학력평가 등
  subject       String?
  grade         String?  // 학년
  
  // 상태
  status        String   @default("PENDING") // PENDING, DOWNLOADED, OCR_PROCESSING, OCR_DONE, PARSED, IMPORTED, FAILED
  ocrConfidence Float?   // OCR 신뢰도 0-1
  problemCount  Int?     // 추출된 문제 수
  
  // 연결된 문제
  importedProblemIds String? // JSON: 가져온 문제 ID 배열
  
  source        CollectionSource @relation(fields: [sourceId], references: [id])
  job           CrawlJob? @relation(fields: [jobId], references: [id])
  
  // Phase 1: 고도화 관계
  reviewQueues  ReviewQueue[]
  ocrTasks      OcrTask[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([sourceId, url])
  @@index([status])
  @@index([jobId])
}

// 수집 로그
model CrawlLog {
  id            String   @id @default(cuid())
  jobId         String
  
  level         String   // DEBUG, INFO, WARN, ERROR
  action        String   // FETCH, DOWNLOAD, OCR, PARSE, IMPORT
  message       String
  details       String?  // JSON
  url           String?
  
  job           CrawlJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@index([jobId, level])
}

// ========================================
// 문제 수집 고도화 Models (Phase 1)
// ========================================

// 검수 대기함
model ReviewQueue {
  id            String   @id @default(cuid())
  itemId        String
  priority      Int      @default(0)  // 우선순위 (높을수록 우선)
  status        String   @default("PENDING") // PENDING, IN_REVIEW, APPROVED, REJECTED
  assignedTo    String?  // 담당자 ID
  reviewType    String   // OCR_ERROR, PARSE_ERROR, QUALITY_CHECK, DUPLICATE
  confidence    Float?   // AI 신뢰도 0-1
  notes         String?  // 검수 메모
  
  item          CrawledItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([status, priority])
  @@index([assignedTo])
}

// OCR 작업
model OcrTask {
  id            String   @id @default(cuid())
  itemId        String
  engine        String   @default("TESSERACT") // TESSERACT, GOOGLE_VISION, AWS_TEXTRACT
  status        String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  confidence    Float?   // 0-1
  text          String?
  errorMessage  String?
  processingMs  Int?     // 처리 시간 (ms)
  
  item          CrawledItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@index([status])
  @@index([itemId])
}

// 배치 작업
model CollectionBatch {
  id            String   @id @default(cuid())
  name          String
  description   String?
  schedule      String?  // cron expression
  isNightMode   Boolean  @default(false)
  status        String   @default("IDLE") // IDLE, QUEUED, RUNNING, PAUSED, COMPLETED
  priority      Int      @default(0)
  
  // 조건
  sourceIds     String   // JSON array of source IDs
  filters       String?  // JSON: 추가 필터 조건
  
  // 결과
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([status])
  @@index([priority])
}

// 수집 통계 (대시보드용)
model CollectionStats {
  id            String   @id @default(cuid())
  date          DateTime @default(now())
  
  // 일별 통계
  problemsCollected Int  @default(0)
  filesProcessed    Int  @default(0)
  successRate       Float @default(0)
  ocrAccuracy       Float @default(0)
  
  // 오류 통계
  errorCount        Int  @default(0)
  topErrorTypes     String?  // JSON: { type: count }
  
  // 소스별 통계
  sourceStats       String?  // JSON: { sourceId: { count, success, failed } }
  
  @@unique([date])
  @@index([date])
}

// ========================================
// SEO Models
// ========================================

// 페이지별 SEO 메타데이터 저장
model PageSEO {
  id              String   @id @default(cuid())
  path            String   @unique    // URL 경로
  title           String
  description     String?
  keywords        String?              // JSON 배열
  ogTitle         String?
  ogDescription   String?
  ogImage         String?
  robots          String   @default("index,follow")
  canonical       String?
  lastModified    DateTime @default(now())
  isAutoGenerated Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([path])
}

// 사이트맵 엔트리
model SitemapEntry {
  id            String   @id @default(cuid())
  loc           String   @unique
  priority      Float    @default(0.5)
  changefreq    String   @default("weekly")
  lastmod       DateTime @default(now())
  isActive      Boolean  @default(true)
  pageType      String                // GRADE, SUBJECT, UNIT, PROBLEM, STATIC
  
  @@index([pageType])
  @@index([isActive])
}

// SEO 메트릭스 추적
model SEOMetrics {
  id            String   @id @default(cuid())
  path          String
  date          DateTime @default(now())
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  ctr           Float?
  avgPosition   Float?
  bounceRate    Float?
  avgTimeOnPage Float?
  
  @@index([path, date])
}

// 키워드 랭킹 추적
model KeywordRanking {
  id            String   @id @default(cuid())
  keyword       String
  path          String
  position      Float?
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  date          DateTime @default(now())
  
  @@index([keyword, date])
  @@index([path])
}

// ========================================
// Gamification & Engagement Models (Phase 1)
// ========================================

// 스트릭 (연속 학습) 시스템
model UserStreak {
  id             String   @id @default(cuid())
  userId         String   @unique
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActiveDate DateTime @default(now())
  freezeCount    Int      @default(0) // 스트릭 보호권
  totalDays      Int      @default(0)
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([currentStreak])
}

// 오늘의 문제
model DailyChallenge {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  problemIds    String   // JSON array
  completedIds  String?  // JSON array
  totalScore    Int      @default(0)
  isCompleted   Boolean  @default(false)
  aiGenerated   Boolean  @default(true)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([date])
}

// 레벨 시스템
model UserLevel {
  id            String   @id @default(cuid())
  userId        String   @unique
  level         Int      @default(1)
  experience    Int      @default(0)
  nextLevelExp  Int      @default(100)
  totalProblems Int      @default(0)
  totalCorrect  Int      @default(0)
  rank          String   @default("BRONZE") // BRONZE, SILVER, GOLD, PLATINUM, DIAMOND
  badges        String?  // JSON array
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 클래스룸 (교사용)
model ClassRoom {
  id            String   @id @default(cuid())
  teacherId     String
  name          String
  description   String?
  inviteCode    String   @unique
  gradeLevel    String
  subjectId     String?
  isActive      Boolean  @default(true)
  maxStudents   Int      @default(50)
  
  teacher       User     @relation("TeacherClassRooms", fields: [teacherId], references: [id])
  members       ClassMember[]
  exams         ClassExam[]
  
  createdAt     DateTime @default(now())
  
  @@index([inviteCode])
  @@index([teacherId])
}

model ClassMember {
  id            String    @id @default(cuid())
  classId       String
  userId        String
  role          String    @default("STUDENT") // STUDENT, TA
  joinedAt      DateTime  @default(now())
  
  class         ClassRoom @relation(fields: [classId], references: [id], onDelete: Cascade)
  user          User      @relation("ClassMemberships", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([classId, userId])
}

// 시험 (교사 생성)
model ClassExam {
  id            String    @id @default(cuid())
  classId       String
  title         String
  problemIds    String    // JSON array
  duration      Int?      // minutes
  startAt       DateTime?
  endAt         DateTime?
  pdfUrl        String?
  isPublished   Boolean   @default(false)
  
  class         ClassRoom @relation(fields: [classId], references: [id], onDelete: Cascade)
  results       ExamResult[]
  
  createdAt     DateTime  @default(now())
}

model ExamResult {
  id            String    @id @default(cuid())
  examId        String
  userId        String
  answers       String    // JSON object
  score         Float?
  submittedAt   DateTime?
  timeSpent     Int?      // seconds
  
  exam          ClassExam @relation(fields: [examId], references: [id], onDelete: Cascade)
  user          User      @relation("ExamResults", fields: [userId], references: [id])
  
  @@unique([examId, userId])
}

// 친구 대결
model Challenge {
  id              String   @id @default(cuid())
  challengerId    String
  challengedId    String
  problemIds      String   // JSON array
  status          String   @default("PENDING") // PENDING, ACTIVE, COMPLETED, DECLINED
  winnerId        String?
  challengerScore Int      @default(0)
  challengedScore Int      @default(0)
  expiresAt       DateTime
  
  challenger      User     @relation("ChallengerChallenges", fields: [challengerId], references: [id])
  challenged      User     @relation("ChallengedChallenges", fields: [challengedId], references: [id])
  
  createdAt       DateTime @default(now())
  
  @@index([challengerId])
  @@index([challengedId])
}

// 랭킹
model Ranking {
  id            String   @id @default(cuid())
  userId        String
  period        String   // DAILY, WEEKLY, MONTHLY, ALL_TIME
  periodKey     String   // e.g., "2024-01-15", "2024-W03"
  scope         String   // GLOBAL, SCHOOL, REGION
  scopeValue    String?  // school name, region name
  score         Int      @default(0)
  rank          Int?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, period, periodKey, scope, scopeValue])
  @@index([period, periodKey, scope, rank])
}

// 문제 평가
model ProblemRating {
  id            String   @id @default(cuid())
  problemId     String
  userId        String
  rating        Int      // 1-5
  difficulty    Int?     // 1-5 (사용자 체감 난이도)
  helpful       Boolean?
  comment       String?
  
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  createdAt     DateTime @default(now())
  
  @@unique([problemId, userId])
  @@index([problemId])
}

// 질문 공유 (공동 풀이)
model SharedQuestion {
  id            String   @id @default(cuid())
  problemId     String
  userId        String
  question      String
  isResolved    Boolean  @default(false)
  upvotes       Int      @default(0)
  
  problem       Problem  @relation(fields: [problemId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  answers       QuestionAnswer[]
  
  createdAt     DateTime @default(now())
  
  @@index([problemId])
}

model QuestionAnswer {
  id            String   @id @default(cuid())
  questionId    String
  userId        String
  content       String
  isAccepted    Boolean  @default(false)
  upvotes       Int      @default(0)
  
  question      SharedQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  createdAt     DateTime @default(now())
}
